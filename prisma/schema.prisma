// Prisma Schema - Platform E-Learning Tutor Nomor Satu
// Database: Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") 
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  TUTOR
  STUDENT
}

enum EnrollmentStatus {
  PENDING   // Awaiting payment
  PAID      // Payment confirmed
  ACTIVE    // Currently enrolled
  COMPLETED // Course completed
  CANCELLED // Enrollment cancelled
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  GRADED
  LATE
}

enum QuizStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  avatar    String?
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentProfile StudentProfile?
  tutorProfile   TutorProfile?
  forumPosts     ForumPost[]
  notifications  Notification[]
  auditLogs      AuditLog[]

  @@index([role])
  @@index([email])
}

model StudentProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  gradeLevel String?
  school    String?
  parentName String?
  parentPhone String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments           Enrollment[]
  assignmentSubmissions AssignmentSubmission[]
  quizAttempts          QuizAttempt[]
  materialBookmarks     MaterialBookmark[]

  @@index([userId])
}

model TutorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  bio         String?
  subjects    String[] // Array of subjects
  experience  Int?     // Years of experience
  education   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes Class[]

  @@index([userId])
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  subject     String
  gradeLevel  String
  price       Int
  capacity    Int
  schedule    String   // e.g., "Senin & Rabu, 19:00-21:00"
  thumbnail   String?
  published   Boolean  @default(false)
  tutorId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tutor         TutorProfile  @relation(fields: [tutorId], references: [id])
  enrollments   Enrollment[]
  materials     Material[]
  assignments   Assignment[]
  quizzes       Quiz[]
  liveClasses   LiveClass[]
  forumThreads  ForumThread[]

  @@index([tutorId])
  @@index([subject])
  @@index([published])
}

model Enrollment {
  id         String           @id @default(cuid())
  studentId  String
  classId    String
  status     EnrollmentStatus @default(PENDING)
  enrolledAt DateTime         @default(now())
  completedAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [id])
  class   Class          @relation(fields: [classId], references: [id])
  payment Payment?

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
}

model Payment {
  id            String        @id @default(cuid())
  enrollmentId  String        @unique
  amount        Int
  paymentMethod String        // QRIS, VA, E-Wallet
  status        PaymentStatus @default(PENDING)
  externalId    String?       // Pakasir transaction ID
  paymentUrl    String?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])

  @@index([externalId])
  @@index([status])
}

model Material {
  id            String   @id @default(cuid())
  classId       String
  title         String
  description   String?  @db.Text
  session       Int      // Pertemuan ke-
  fileType      String   // PDF, VIDEO, LINK, DOCUMENT, IMAGE
  fileUrl       String?
  videoUrl      String?  // YouTube/Vimeo/Drive embed
  thumbnail     String?  // Thumbnail image URL
  viewCount     Int      @default(0)
  downloadCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  class     Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  bookmarks MaterialBookmark[]

  @@index([classId])
  @@index([session])
}

model Assignment {
  id           String           @id @default(cuid())
  classId      String
  title        String
  instructions String           @db.Text
  dueDate      DateTime
  maxPoints    Int              @default(100)
  attachmentUrl String?
  status       AssignmentStatus @default(DRAFT)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  class       Class                  @relation(fields: [classId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@index([classId])
  @@index([dueDate])
  @@index([status])
}

model AssignmentSubmission {
  id           String           @id @default(cuid())
  assignmentId String
  studentId    String
  fileUrl      String
  status       SubmissionStatus @default(SUBMITTED)
  score        Int?
  feedback     String?          @db.Text
  submittedAt  DateTime         @default(now())
  gradedAt     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  assignment Assignment     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    StudentProfile @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

model Quiz {
  id            String     @id @default(cuid())
  classId       String
  title         String
  description   String?    @db.Text
  timeLimit     Int?       // Minutes
  startDate     DateTime?
  endDate       DateTime?
  passingGrade  Int?
  status        QuizStatus @default(DRAFT)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  class     Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@index([classId])
  @@index([status])
}

model QuizQuestion {
  id              String   @id @default(cuid())
  quizId          String
  questionType    String   // MULTIPLE_CHOICE, TRUE_FALSE, SHORT_ANSWER
  questionText    String   @db.Text
  options         String[] // For MCQ
  correctAnswer   String
  explanation     String?  @db.Text
  points          Int      @default(10)
  orderIndex      Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  quiz    Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  @@index([quizId])
}

model QuizAttempt {
  id          String    @id @default(cuid())
  quizId      String
  studentId   String
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  score       Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quiz    Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id])
  answers QuizAnswer[]

  @@index([quizId])
  @@index([studentId])
}

model QuizAnswer {
  id         String   @id @default(cuid())
  attemptId  String
  questionId String
  answer     String
  isCorrect  Boolean?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  attempt  QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model LiveClass {
  id          String   @id @default(cuid())
  classId     String
  title       String
  meetingUrl  String
  scheduledAt DateTime
  duration    Int      // Minutes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([scheduledAt])
}

model ForumThread {
  id        String   @id @default(cuid())
  classId   String
  authorId  String
  title     String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  posts ForumPost[]

  @@index([classId])
}

model ForumPost {
  id         String   @id @default(cuid())
  threadId   String
  authorId   String
  content    String   @db.Text
  parentId   String?  // For replies
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  thread  ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author  User        @relation(fields: [authorId], references: [id])
  parent  ForumPost?  @relation("PostReplies", fields: [parentId], references: [id])
  replies ForumPost[] @relation("PostReplies")

  @@index([threadId])
  @@index([authorId])
  @@index([parentId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  type      String   // ASSIGNMENT, QUIZ, PAYMENT, LIVE_CLASS, etc.
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model MaterialBookmark {
  id         String   @id @default(cuid())
  studentId  String
  materialId String
  createdAt  DateTime @default(now())

  student  StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  material Material       @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([studentId, materialId])
  @@index([studentId])
  @@index([materialId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String   // User, Class, Payment, etc.
  entityId  String
  metadata  Json?  @db.Json
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}
