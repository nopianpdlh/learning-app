// Prisma Schema - Platform E-Learning Tutor Nomor Satu
// Database: Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") 
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  TUTOR
  STUDENT
}

enum EnrollmentStatus {
  WAITING       // Di waiting list (menunggu approval)
  PENDING       // Menunggu pembayaran
  ACTIVE        // Aktif (bisa ikut kelas)
  EXPIRED       // Periode 30 hari habis (dalam grace period)
  SLOT_RELEASED // Grace period habis, slot dilepas
  CANCELLED     // Dibatalkan
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  EXPIRED
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  GRADED
  LATE
}

enum QuizStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

// New enums for Class Management System
enum ClassType {
  SEMI_PRIVATE  // 2-10 siswa per section
  PRIVATE       // 1 siswa (1-on-1)
}

enum SectionStatus {
  ACTIVE        // Masih terima siswa
  FULL          // Sudah max capacity
  ARCHIVED      // Non-aktif
}

enum WaitingStatus {
  PENDING       // Menunggu review admin
  APPROVED      // Disetujui, waiting payment
  REJECTED      // Ditolak
  EXPIRED       // Timeout, tidak bayar
}

enum MeetingStatus {
  SCHEDULED     // Terjadwal
  LIVE          // Sedang berlangsung
  COMPLETED     // Selesai
  CANCELLED     // Dibatalkan
}

enum AttendanceStatus {
  PENDING       // Meeting belum mulai
  PRESENT       // Hadir
  ABSENT        // Tidak hadir (quota tetap berkurang)
}

enum InvoiceStatus {
  UNPAID        // Belum dibayar
  PAID          // Sudah dibayar
  OVERDUE       // Lewat jatuh tempo
  CANCELLED     // Dibatalkan
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  avatar    String?
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentProfile StudentProfile?
  tutorProfile   TutorProfile?
  forumPosts     ForumPost[]
  notifications  Notification[]
  auditLogs      AuditLog[]

  @@index([role])
  @@index([email])
}

model StudentProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  gradeLevel String?
  school    String?
  parentName String?
  parentPhone String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments           Enrollment[]
  assignmentSubmissions AssignmentSubmission[]
  quizAttempts          QuizAttempt[]
  materialBookmarks     MaterialBookmark[]
  liveClassAttendances  LiveClassAttendance[]
  waitingList           WaitingList[]          // NEW: Waiting list entries

  @@index([userId])
}

model TutorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  bio         String?
  subjects    String[] // Array of subjects
  experience  Int?     // Years of experience
  education   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes      Class[]            // Legacy: existing classes
  sections     ClassSection[]     // NEW: Class sections
  availability TutorAvailability[] // NEW: Availability slots

  @@index([userId])
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  subject     String
  gradeLevel  String
  price       Int
  capacity    Int
  schedule    String   // e.g., "Senin & Rabu, 19:00-21:00"
  thumbnail   String?
  published   Boolean  @default(false)
  tutorId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tutor         TutorProfile  @relation(fields: [tutorId], references: [id])
  enrollments   Enrollment[]
  materials     Material[]
  assignments   Assignment[]
  quizzes       Quiz[]
  liveClasses   LiveClass[]
  forumThreads  ForumThread[]

  @@index([tutorId])
  @@index([subject])
  @@index([published])
}

model Enrollment {
  id         String           @id @default(cuid())
  studentId  String
  classId    String?          // Legacy: Made optional for migration
  sectionId  String?          // NEW: Section-based enrollment
  status     EnrollmentStatus @default(PENDING)
  
  // Subscription Period (Rolling 30 days)
  startDate       DateTime?         // Tanggal mulai aktif
  expiryDate      DateTime?         // startDate + 30 days
  graceExpiryDate DateTime?         // expiryDate + 7 days (grace period)
  
  // Meeting Quota Tracking
  meetingsAllowed   Int   @default(8)
  meetingsAttended  Int   @default(0)
  
  enrolledAt  DateTime         @default(now())
  completedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  student    StudentProfile      @relation(fields: [studentId], references: [id])
  class      Class?              @relation(fields: [classId], references: [id])
  section    ClassSection?       @relation(fields: [sectionId], references: [id])
  payment    Payment?
  attendance MeetingAttendance[]
  invoices   Invoice[]

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([sectionId])
  @@index([status])
  @@index([expiryDate])
  @@index([graceExpiryDate])
}

model Payment {
  id            String        @id @default(cuid())
  enrollmentId  String        @unique
  amount        Int
  paymentMethod String        // bank_transfer, gopay, qris, etc
  status        PaymentStatus @default(PENDING)
  
  
  externalId    String?       
  
  // Midtrans Specific
  orderId       String?       @unique // Format: "INV-{invoiceNumber}"
  transactionId String?       // Midtrans transaction_id
  paymentType   String?       // Midtrans payment_type
  vaNumber      String?       // Virtual Account number
  snapToken     String?       // Midtrans Snap token
  redirectUrl   String?       // Snap redirect URL
  expiredAt     DateTime?     // Payment expiry time
  
  paymentUrl    String?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  invoice    Invoice?

  @@index([externalId])
  @@index([orderId])
  @@index([transactionId])
  @@index([status])
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique  // Format: INV-YYYYMMDD-XXXX
  paymentId      String?       @unique
  enrollmentId   String
  
  // Billing Info
  studentName    String
  studentEmail   String
  studentPhone   String?
  
  // Items
  programName    String
  sectionLabel   String
  periodStart    DateTime
  periodEnd      DateTime
  
  // Amounts
  amount         Int           // Base price
  tax            Int           @default(0)
  discount       Int           @default(0)
  totalAmount    Int           // Final amount to pay
  
  // Status
  status         InvoiceStatus @default(UNPAID)
  dueDate        DateTime      // Invoice expiry
  paidAt         DateTime?
  
  notes          String?       @db.Text
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  payment        Payment?      @relation(fields: [paymentId], references: [id])
  enrollment     Enrollment    @relation(fields: [enrollmentId], references: [id])
  
  @@index([invoiceNumber])
  @@index([enrollmentId])
  @@index([status])
  @@index([dueDate])
}

model Material {
  id            String   @id @default(cuid())
  classId       String
  title         String
  description   String?  @db.Text
  session       Int      // Pertemuan ke-
  fileType      String   // PDF, VIDEO, LINK, DOCUMENT, IMAGE
  fileUrl       String?
  videoUrl      String?  // YouTube/Vimeo/Drive embed
  thumbnail     String?  // Thumbnail image URL
  viewCount     Int      @default(0)
  downloadCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  class     Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  bookmarks MaterialBookmark[]

  @@index([classId])
  @@index([session])
}

model Assignment {
  id           String           @id @default(cuid())
  classId      String
  title        String
  instructions String           @db.Text
  dueDate      DateTime
  maxPoints    Int              @default(100)
  attachmentUrl String?
  status       AssignmentStatus @default(DRAFT)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  class       Class                  @relation(fields: [classId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@index([classId])
  @@index([dueDate])
  @@index([status])
}

model AssignmentSubmission {
  id           String           @id @default(cuid())
  assignmentId String
  studentId    String
  fileUrl      String
  status       SubmissionStatus @default(SUBMITTED)
  score        Int?
  feedback     String?          @db.Text
  submittedAt  DateTime         @default(now())
  gradedAt     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  assignment Assignment     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    StudentProfile @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

model Quiz {
  id            String     @id @default(cuid())
  classId       String
  title         String
  description   String?    @db.Text
  timeLimit     Int?       // Minutes
  startDate     DateTime?
  endDate       DateTime?
  passingGrade  Int?
  status        QuizStatus @default(DRAFT)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  class     Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@index([classId])
  @@index([status])
}

model QuizQuestion {
  id              String   @id @default(cuid())
  quizId          String
  questionType    String   // MULTIPLE_CHOICE, TRUE_FALSE, SHORT_ANSWER
  questionText    String   @db.Text
  options         String[] // For MCQ
  correctAnswer   String
  explanation     String?  @db.Text
  points          Int      @default(10)
  orderIndex      Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  quiz    Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  @@index([quizId])
}

model QuizAttempt {
  id          String    @id @default(cuid())
  quizId      String
  studentId   String
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  score       Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quiz    Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id])
  answers QuizAnswer[]

  @@index([quizId])
  @@index([studentId])
}

model QuizAnswer {
  id         String   @id @default(cuid())
  attemptId  String
  questionId String
  answer     String
  isCorrect  Boolean?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  attempt  QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model LiveClass {
  id              String    @id @default(cuid())
  classId         String
  title           String
  description     String?   @db.Text
  meetingUrl      String
  scheduledAt     DateTime
  duration        Int       // Minutes
  maxParticipants Int?
  recordingUrl    String?
  status          String    @default("SCHEDULED") // SCHEDULED, LIVE, COMPLETED, CANCELLED
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  class       Class                 @relation(fields: [classId], references: [id], onDelete: Cascade)
  attendances LiveClassAttendance[]

  @@index([classId])
  @@index([scheduledAt])
  @@index([status])
}

model LiveClassAttendance {
  id          String   @id @default(cuid())
  liveClassId String
  studentId   String
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  createdAt   DateTime @default(now())

  liveClass LiveClass      @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  student   StudentProfile @relation(fields: [studentId], references: [id])

  @@unique([liveClassId, studentId])
  @@index([liveClassId])
  @@index([studentId])
}

model ForumThread {
  id        String   @id @default(cuid())
  classId   String
  authorId  String
  title     String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  posts ForumPost[]

  @@index([classId])
}

model ForumPost {
  id         String   @id @default(cuid())
  threadId   String
  authorId   String
  content    String   @db.Text
  parentId   String?  // For replies
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  thread  ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author  User        @relation(fields: [authorId], references: [id])
  parent  ForumPost?  @relation("PostReplies", fields: [parentId], references: [id])
  replies ForumPost[] @relation("PostReplies")

  @@index([threadId])
  @@index([authorId])
  @@index([parentId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  type      String   // ASSIGNMENT, QUIZ, PAYMENT, LIVE_CLASS, SUBSCRIPTION, CLASS
  read      Boolean  @default(false)
  link      String?  // Optional link for actionable notifications
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model MaterialBookmark {
  id         String   @id @default(cuid())
  studentId  String
  materialId String
  createdAt  DateTime @default(now())

  student  StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  material Material       @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([studentId, materialId])
  @@index([studentId])
  @@index([materialId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String   // User, Class, Payment, etc.
  entityId  String
  metadata  Json?  @db.Json
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// NEW MODELS - Class Management System
// ============================================

model ClassTemplate {
  id                    String    @id @default(cuid())
  name                  String    // "Semi-Private Grammar"
  description           String    @db.Text
  subject               String
  gradeLevel            String    // "Dewasa", "Anak"
  classType             ClassType
  pricePerMonth         Int       // Harga per 30 hari
  maxStudentsPerSection Int       @default(10) // Max per section
  meetingsPerPeriod     Int       @default(8)  // 8 meetings
  periodDays            Int       @default(30) // 30 hari
  gracePeriodDays       Int       @default(7)  // 7 hari grace period
  thumbnail             String?
  published             Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  sections    ClassSection[]
  waitingList WaitingList[]

  @@index([classType])
  @@index([published])
  @@index([subject])
}

model ClassSection {
  id                 String        @id @default(cuid())
  templateId         String
  sectionLabel       String        // "A", "B", "C"
  tutorId            String
  status             SectionStatus @default(ACTIVE)
  currentEnrollments Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  template    ClassTemplate      @relation(fields: [templateId], references: [id])
  tutor       TutorProfile       @relation(fields: [tutorId], references: [id])
  enrollments Enrollment[]
  meetings    ScheduledMeeting[]

  @@unique([templateId, sectionLabel])
  @@index([templateId])
  @@index([tutorId])
  @@index([status])
}

model TutorAvailability {
  id        String   @id @default(cuid())
  tutorId   String
  dayOfWeek Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime String   // "09:00"
  endTime   String   // "12:00"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tutor TutorProfile @relation(fields: [tutorId], references: [id])

  @@unique([tutorId, dayOfWeek, startTime]) // No duplicate slots
  @@index([tutorId])
  @@index([dayOfWeek])
}

model WaitingList {
  id                String        @id @default(cuid())
  studentId         String
  templateId        String        // Program yang diinginkan
  status            WaitingStatus @default(PENDING)
  requestedAt       DateTime      @default(now())
  approvedAt        DateTime?
  approvedBy        String?       // Admin ID
  rejectedAt        DateTime?
  rejectionNote     String?
  assignedSectionId String?       // Section yang di-assign saat approve
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  student  StudentProfile @relation(fields: [studentId], references: [id])
  template ClassTemplate  @relation(fields: [templateId], references: [id])

  @@unique([studentId, templateId]) // 1 siswa 1 waiting per program
  @@index([templateId])
  @@index([status])
}

model ScheduledMeeting {
  id           String        @id @default(cuid())
  sectionId    String
  title        String
  description  String?
  scheduledAt  DateTime
  duration     Int           // Minutes
  meetingUrl   String?
  status       MeetingStatus @default(SCHEDULED)
  createdBy    String        // Admin yang buat
  recordingUrl String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  section    ClassSection        @relation(fields: [sectionId], references: [id])
  attendance MeetingAttendance[]

  @@index([sectionId])
  @@index([scheduledAt])
  @@index([status])
}

model MeetingAttendance {
  id           String           @id @default(cuid())
  meetingId    String
  enrollmentId String
  status       AttendanceStatus @default(PENDING)
  joinedAt     DateTime?
  leftAt       DateTime?
  markedBy     String?          // Admin/Tutor yang mark attendance
  markedAt     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  meeting    ScheduledMeeting @relation(fields: [meetingId], references: [id])
  enrollment Enrollment       @relation(fields: [enrollmentId], references: [id])

  @@unique([meetingId, enrollmentId])
  @@index([meetingId])
  @@index([enrollmentId])
  @@index([status])
}
